<?php
 namespace imwpf\apis; class Process { public function start() { add_action('wp_ajax_imwpf_process', array($this, 'run')); add_action('wp_ajax_nopriv_imwpf_process', array($this, 'run')); } public function run() { ignore_user_abort(); if (file_exists(__DIR__ . '/heartbeat')) { return ; } $this->executeTask(); register_shutdown_function(function(){ $this->continueExecuteTask(); }); } public function executeTask() { file_put_contents(__DIR__ . '/log', posix_getpid() . "\n", FILE_APPEND); sleep(5); } public function continueExecuteTask() { return false; $url = admin_url('/admin-ajax.php') . '?action=imwpf_process'; $component = parse_url($url); $fp = stream_socket_client("tcp://{$component['host']}:80", $errno, $errstr, 30); if (!$fp) { return ; } $path = $component['path'] . '?' . $component['query']; $content = "GET {$path} HTTP/1.1\r\nHost: {$component['host']}\r\nAccept: */*\r\n\r\n"; fwrite($fp, $content); fread($fp, 1); fclose($fp); } } 